/**
 * Archivo puente para scanner.js
 * 
 * Este archivo mantiene la compatibilidad hacia atr√°s con el c√≥digo existente
 * que depende de las funciones de scanner.js, dirigiendo las llamadas
 * al nuevo BasicScannerService.
 * 
 * @file scanner-bridge.js
 * @author Angel Aramiz
 * @version 2.0.0
 */

// Importar servicio especializado
import { basicScannerService } from '../core/services/BasicScannerService.js';

/**
 * Inicializar esc√°ner b√°sico
 */
export async function initScanner() {
    try {
        console.log('üîÑ Inicializando servicio de esc√°ner b√°sico...');
        
        await basicScannerService.initialize();
        
        console.log('‚úÖ Servicio de esc√°ner b√°sico inicializado');
        return true;
        
    } catch (error) {
        console.error('‚ùå Error al inicializar servicio de esc√°ner:', error);
        throw error;
    }
}

/**
 * Funci√≥n de compatibilidad para iniciar escaneo
 * @param {string} containerId - ID del contenedor (opcional)
 */
export async function iniciarEscaneo(containerId = 'reader') {
    try {
        // Verificar permisos primero
        const hasPermissions = await basicScannerService.checkCameraPermissions();
        if (!hasPermissions) {
            throw new Error('Se requiere acceso a la c√°mara');
        }
        
        // Mostrar contenedor si existe
        const scannerContainer = document.getElementById("scanner-container");
        if (scannerContainer) {
            scannerContainer.style.display = "block";
        }
        
        return await basicScannerService.startScanner(containerId);
        
    } catch (error) {
        console.error("Error al iniciar el esc√°ner:", error);
        
        // Mostrar mensaje de error si la funci√≥n est√° disponible
        if (typeof mostrarMensaje !== 'undefined') {
            mostrarMensaje("Se requiere acceso a la c√°mara", "error");
        }
        
        throw error;
    }
}

/**
 * Funci√≥n para toggle del esc√°ner con modal
 * @param {string} inputId - ID del input objetivo
 */
export async function toggleEscaner(inputId) {
    try {
        if (inputId) {
            // Usar modal del esc√°ner si est√° disponible mostrarModalEscaneo
            if (typeof mostrarModalEscaneo !== 'undefined') {
                mostrarModalEscaneo(inputId);
            } else {
                // Fallback: usar modal del BasicScannerService
                await basicScannerService.startModalScanner(inputId);
            }
        }
    } catch (error) {
        console.error('Error en toggleEscaner:', error);
    }
}

/**
 * Detener el esc√°ner
 */
export async function detenerEscaner() {
    try {
        return await basicScannerService.stopScanner();
    } catch (error) {
        console.error('Error al detener esc√°ner:', error);
        return false;
    }
}

/**
 * Iniciar esc√°ner con modal (compatibilidad)
 * @param {string} inputId - ID del input objetivo
 */
export async function iniciarEscaneoConModal(inputId) {
    try {
        return await basicScannerService.startModalScanner(inputId);
    } catch (error) {
        console.error("Error en iniciarEscaneoConModal:", error);
        
        if (typeof mostrarMensaje !== 'undefined') {
            mostrarMensaje("Error al iniciar el esc√°ner. Verifica los permisos de la c√°mara.", "error");
        }
        
        throw error;
    }
}

/**
 * Manejar c√≥digo escaneado (compatibilidad)
 * @param {string} codigo - C√≥digo escaneado
 * @param {Object} formato - Objeto con informaci√≥n del formato
 * @param {Function} callback - Callback a ejecutar
 */
export function manejarCodigoEscaneado(codigo, formato, callback) {
    try {
        // Extraer nombre del formato
        const formatName = formato?.result?.format?.formatName?.toLowerCase() || 'unknown';
        
        // Procesar c√≥digo usando el servicio
        const processedCode = basicScannerService.processCodeByFormat(
            basicScannerService.sanitizeCode(codigo), 
            formatName
        );
        
        // Mostrar mensajes si la funci√≥n est√° disponible
        if (typeof mostrarMensaje !== 'undefined') {
            mostrarMensaje(`C√≥digo escaneado: ${processedCode}`, "info");
            
            if (formatName === "code_128" && processedCode !== codigo) {
                mostrarMensaje(`C√≥digo parcial extra√≠do: ${processedCode}`, "info");
            }
        }
        
        // Ejecutar callback
        if (callback && typeof callback === 'function') {
            callback(processedCode);
        }
        
        return processedCode;
        
    } catch (error) {
        console.error('Error al manejar c√≥digo escaneado:', error);
        
        if (typeof mostrarMensaje !== 'undefined') {
            mostrarMensaje("Error al procesar c√≥digo escaneado", "error");
        }
        
        return codigo; // Devolver c√≥digo original en caso de error
    }
}

/**
 * Reproducir tono (compatibilidad)
 * @param {number} frequency - Frecuencia en Hz
 * @param {number} duration - Duraci√≥n en segundos
 * @param {string} type - Tipo de onda
 */
export function playTone(frequency, duration, type = 'sine') {
    try {
        return basicScannerService.playTone(frequency, duration, type);
    } catch (error) {
        console.error('Error al reproducir tono:', error);
    }
}

/**
 * Configurar esc√°ner
 * @param {Object} configuracion - Nueva configuraci√≥n
 */
export function configurarEscaner(configuracion) {
    try {
        return basicScannerService.updateConfig(configuracion);
    } catch (error) {
        console.error('Error al configurar esc√°ner:', error);
        throw error;
    }
}

/**
 * Obtener configuraci√≥n del esc√°ner
 * @returns {Object} Configuraci√≥n actual
 */
export function obtenerConfiguracionEscaner() {
    try {
        return basicScannerService.getConfig();
    } catch (error) {
        console.error('Error al obtener configuraci√≥n:', error);
        return {};
    }
}

/**
 * Obtener estado del esc√°ner
 * @returns {Object} Estado actual
 */
export function obtenerEstadoEscaner() {
    try {
        return basicScannerService.getScannerState();
    } catch (error) {
        console.error('Error al obtener estado:', error);
        return { isScanning: false };
    }
}

/**
 * Verificar si el esc√°ner est√° activo
 * @returns {boolean} Si est√° escaneando
 */
export function isEscanerActivo() {
    try {
        return basicScannerService.getScannerState().isScanning;
    } catch (error) {
        return false;
    }
}

/**
 * Cerrar modal del esc√°ner
 */
export async function cerrarModalEscaner() {
    try {
        return await basicScannerService.closeScannerModal();
    } catch (error) {
        console.error('Error al cerrar modal:', error);
    }
}

/**
 * Inicializar con verificaci√≥n de permisos
 */
export async function inicializarConPermisos() {
    try {
        await initScanner();
        const hasPermissions = await basicScannerService.checkCameraPermissions();
        
        if (!hasPermissions) {
            console.warn('Permisos de c√°mara no disponibles');
            
            if (typeof mostrarMensaje !== 'undefined') {
                mostrarMensaje("Se requiere acceso a la c√°mara para usar el esc√°ner", "warning");
            }
        }
        
        return hasPermissions;
        
    } catch (error) {
        console.error('Error en inicializaci√≥n con permisos:', error);
        return false;
    }
}

/**
 * Manejar esc√°ner para input espec√≠fico con b√∫squeda autom√°tica
 * @param {string} inputId - ID del input
 * @param {string} searchType - Tipo de b√∫squeda
 */
export async function escanearParaInput(inputId, searchType = 'auto') {
    try {
        const callback = (code, format) => {
            // Actualizar input
            const input = document.getElementById(inputId);
            if (input) {
                input.value = code;
            }
            
            // Ejecutar b√∫squeda seg√∫n tipo
            setTimeout(async () => {
                try {
                    switch (searchType) {
                        case 'consulta':
                            const { buscarProducto } = await import('./product-operations-bridge.js');
                            buscarProducto(code, format);
                            break;
                        case 'editar':
                            const { buscarProductoParaEditar } = await import('./product-operations-bridge.js');
                            buscarProductoParaEditar(code, format);
                            break;
                        case 'inventario':
                            const { buscarProductoInventario } = await import('./product-operations-bridge.js');
                            buscarProductoInventario(code, format);
                            break;
                        default:
                            // Auto-detectar seg√∫n inputId
                            if (inputId.includes('consulta')) {
                                const { buscarProducto } = await import('./product-operations-bridge.js');
                                buscarProducto(code, format);
                            } else if (inputId.includes('editar')) {
                                const { buscarProductoParaEditar } = await import('./product-operations-bridge.js');
                                buscarProductoParaEditar(code, format);
                            } else {
                                const { buscarProductoInventario } = await import('./product-operations-bridge.js');
                                buscarProductoInventario(code, format);
                            }
                    }
                } catch (error) {
                    console.error('Error en b√∫squeda autom√°tica:', error);
                }
            }, 100);
        };
        
        return await basicScannerService.startModalScanner(inputId, callback);
        
    } catch (error) {
        console.error('Error en escanearParaInput:', error);
        throw error;
    }
}

/**
 * Variables globales para compatibilidad hacia atr√°s
 */
if (typeof window !== 'undefined') {
    // Exponer funciones globalmente
    window.scannerBasico = {
        iniciarEscaneo,
        toggleEscaner,
        detenerEscaner,
        iniciarEscaneoConModal,
        manejarCodigoEscaneado,
        playTone,
        configurarEscaner,
        obtenerConfiguracionEscaner,
        obtenerEstadoEscaner,
        isEscanerActivo,
        cerrarModalEscaner,
        inicializarConPermisos,
        escanearParaInput
    };
    
    // Exponer servicio
    window.basicScannerService = basicScannerService;
    
    // Auto-inicializaci√≥n
    document.addEventListener('DOMContentLoaded', () => {
        initScanner().catch(error => {
            console.warn('Auto-inicializaci√≥n de esc√°ner b√°sico fall√≥:', error.message);
        });
    });
    
    // Si el DOM ya est√° cargado
    if (document.readyState !== 'loading') {
        initScanner().catch(error => {
            console.warn('Auto-inicializaci√≥n de esc√°ner b√°sico fall√≥:', error.message);
        });
    }
}

export {
    basicScannerService
};

export default {
    initScanner,
    iniciarEscaneo,
    toggleEscaner,
    detenerEscaner,
    iniciarEscaneoConModal,
    manejarCodigoEscaneado,
    playTone,
    configurarEscaner,
    obtenerConfiguracionEscaner,
    obtenerEstadoEscaner,
    isEscanerActivo,
    cerrarModalEscaner,
    inicializarConPermisos,
    escanearParaInput,
    
    // Servicio
    service: basicScannerService
};
