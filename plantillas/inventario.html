<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario</title>

    <!-- Favicon y iconos -->
    <link rel="icon" type="image/svg+xml" href="../assets/logo.svg">
    <link rel="icon" type="image/x-icon" href="../assets/favicon.ico">
    <link rel="apple-touch-icon" href="../assets/logo.svg">

    <link href="../librer√≠as/tailwind.min.css" rel="stylesheet">
    <script src="../librer√≠as/sweetalert2@11.js"></script>
    <script src="../librer√≠as/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/mobile-components.css">
    <script src="../js/ui/theme-manager.js"></script>
    
    <!-- Cargar Supabase como script tradicional -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.40.0/dist/umd/supabase.js"></script>
    
    <!-- CSS para ocultar controles de HTML5QrCode en m√≥vil -->
    <style>
        /* En m√≥vil: ocultar solo los controles, mantener el video visible */
        @media (max-width: 640px) {
            #qr-scanner {
                max-height: 160px !important;
                overflow: hidden !important;
            }
            
            /* Ocultar botones y controles espec√≠ficos */
            #qr-scanner button {
                display: none !important;
            }
            
            /* Ocultar el div del "Powered by ScanApp" y similares */
            #qr-scanner div[style*="position: absolute"] {
                display: none !important;
            }
            
            /* Ocultar zoom slider */
            #qr-scanner .html5-qrcode-zoom-slider {
                display: none !important;
            }
            
            /* Mostrar el contenedor de video */
            #qr-scanner .html5-qrcode-element {
                display: block !important;
                max-height: 160px !important;
                overflow: hidden !important;
            }
            
            /* Asegurar que el video es visible */
            #qr-scanner video {
                max-height: 160px !important;
                object-fit: contain !important;
            }
        }
    </style>
</head>

<body class="bg-gray-100 dark-theme-body">
    <header class="bg-blue-600 text-white p-4 flex justify-between items-center dark-theme-header">
        <h1 class="text-3xl font-bold dark-theme-title">Inventario</h1>
        <div class="flex items-center space-x-4">
            <!-- Bot√≥n de alternar tema -->
            <button id="themeToggleBtn" class="p-2 rounded-lg bg-blue-700 hover:bg-blue-800 transition-colors"
                title="Alternar tema">
                <svg id="themeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z">
                    </path>
                </svg>
            </button>
        </div>
    </header>

    <div id="sideMenu"
        class="fixed top-0 left-0 w-64 h-full bg-white shadow-lg transform -translate-x-full transition-transform dark-theme-sidebar">
        <div class="p-4 border-b dark-theme-sidebar-header">
            <h2 class="text-xl font-bold dark-theme-title">Men√∫ de Navegaci√≥n</h2>
            <button id="closeMenu" class="text-red-500 hover:underline mt-2 dark-theme-close-btn">Cerrar</button>
        </div>
        <ul id="menuRoutes" class="p-4 space-y-2 dark-theme-nav-list">
            <!-- Las rutas se generar√°n din√°micamente -->
        </ul>
    </div>

    <div id="inventario" class="container mx-auto mt-8 p-4">
        <h1 class="text-3xl font-bold mb-6 dark-theme-title">Inventario</h1>

        <a href="./main.html" class="text-blue-500 hover:underline mb-4 inline-block">‚Üê Regresar</a>
        <button id="menuToggle" class="bg-white text-blue-600 px-4 py-2 rounded hover:bg-gray-200">
            Men√∫
        </button>

        <!-- Nuevo div para mostrar la ubicaci√≥n actual -->
        <div class="mb-4 p-4 bg-white shadow-md rounded">
            <h2 class="text-xl font-bold mb-2">Ubicaci√≥n Actual: <span id="ubicacionActual"></span></h2>
            <button id="cambiarUbicacion" class="bg-yellow-500 text-white px-4 py-2">Cambiar Ubicaci√≥n</button>
        </div>

        <!-- Pesta√±as principales de inventario -->
        <div class="mb-6">
            <div class="flex border-b bg-white shadow-sm rounded-t-lg">
                <button id="tabInventarioManual"
                    class="px-6 py-3 bg-blue-500 text-white rounded-t-lg border-b-2 border-blue-500 font-semibold">
                    üì¶ Inventario Manual
                </button>
                <button id="tabLotesAvanzado"
                    class="px-6 py-3 bg-gray-200 text-gray-700 rounded-t-lg ml-2 hover:bg-gray-300 font-semibold">
                    üöÄ Inventario por Lotes Avanzado
                </button>
            </div>
        </div>

        <!-- Contenido de Inventario Manual -->
        <div id="contenidoInventarioManual" class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
            <!-- Formulario de b√∫squeda de inventario -->
            <div class="mb-4">
                <label for="codigo" class="block mb-2">C√≥digo/PLU:</label>
                <div class="flex">
                    <input type="text" id="codigo" class="border p-2 w-full">
                    <button id="escanearBtn" class="bg-blue-500 text-white px-4 py-2 ml-2">Escanear C√≥digo</button>
                </div>
            </div>

            <div class="mb-4">
                <label for="nombreInventario" class="block mb-2">Nombre:</label>
                <input type="text" id="nombreInventario" class="border p-2 w-full">
            </div>

            <div class="mb-4">
                <label for="marcaInventario" class="block mb-2">Marca:</label>
                <input type="text" id="marcaInventario" class="border p-2 w-full">
            </div>

            <button id="buscarInventario" class="bg-green-500 text-white px-4 py-2 mb-4">Buscar Producto</button>

            <div id="resultadosInventario" class="mt-4" style="display: none;">
                <!-- Los resultados de la b√∫squeda se mostrar√°n aqu√≠ -->
            </div>

            <div id="datosInventario" class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4" style="display: none;">
                <!-- Pesta√±as para productos tipo Kg -->
                <div id="tabsContainer" class="mb-6" style="display: none;">
                    <div class="flex border-b">
                        <button id="tabInventario"
                            class="px-4 py-2 bg-blue-500 text-white rounded-t-lg border-b-2 border-blue-500">
                            Inventario Normal
                        </button>
                        <button id="tabLotes"
                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-t-lg ml-2 hover:bg-gray-300">
                            Lotes
                        </button>
                    </div>
                </div>

                <!-- Formulario de inventario normal -->
                <div id="formularioInventarioNormal">
                    <div class="mb-4">
                        <label for="codigoProductoInventario" class="block mb-2">Codigo del Producto:</label>
                        <input type="text" id="codigoProductoInventario" class="border p-2 w-full" readonly>
                    </div>
                    <div class="mb-4">
                        <label for="nombreProductoInventario" class="block mb-2">Nombre del Producto:</label>
                        <input type="text" id="nombreProductoInventario" class="border p-2 w-full" readonly>
                    </div>

                    <div class="mb-4">
                        <label for="unidadProducto" class="block mb-2">Unidad:</label>
                        <input type="text" id="unidadProducto" class="border p-2 w-full" readonly>
                        <!-- Mostrar la unidad como texto -->
                    </div>

                    <div class="mb-4">
                        <label for="cantidad" class="block mb-2">Cantidad:</label>
                        <input type="number" id="cantidad" class="border p-2 w-full">
                    </div>

                    <div class="mb-4">
                        <label for="fechaCaducidad" class="block mb-2">Fecha de Caducidad:</label>
                        <input type="date" id="fechaCaducidad" class="border p-2 w-full">
                    </div>

                    <div class="mb-6">
                        <label for="comentarios" class="block mb-2">Comentarios:</label>
                        <textarea id="comentarios" class="border p-2 w-full"></textarea>
                    </div>

                    <div id="botonguardar" class="flex items-center justify-between">
                        <button id="guardarInventario" class="bg-blue-500 text-white px-4 py-2">Guardar
                            Inventario</button>
                    </div>
                    <div id="botonmodificar" class="flex items-center justify-between" style="display: none;">
                        <button id="modificarInventario" class="bg-blue-500 text-white px-4 py-2">Modificar
                            Inventario</button>
                    </div>
                </div>

                <!-- Formulario de escaneo por lotes para productos Kg -->
                <div id="formularioLotes" style="display: none;">
                    <div class="bg-blue-50 p-4 rounded-lg mb-6">
                        <h3 class="text-lg font-bold mb-3 text-blue-800">Informaci√≥n del Producto</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">C√≥digo:</label>
                                <span id="codigoProductoLotes" class="text-sm font-semibold"></span>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre:</label>
                                <span id="nombreProductoLotes" class="text-sm font-semibold"></span>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Unidad:</label>
                                <span id="unidadProductoLotes" class="text-sm font-semibold text-green-600">Kg</span>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Categor√≠a:</label>
                                <span id="categoriaProductoLotes" class="text-sm font-semibold"></span>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Marca:</label>
                                <span id="marcaProductoLotes" class="text-sm font-semibold"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label for="precioKilo" class="block text-sm font-medium text-gray-700 mb-2">Precio por Kilo
                            ($):</label>
                        <input type="number" id="precioKilo" step="0.01" min="0"
                            class="border border-gray-300 rounded-lg p-3 w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Ingrese el precio por kilogramo">
                    </div>

                    <div class="text-center">
                        <button id="iniciarEscaneoLotes"
                            class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg disabled:bg-gray-300 disabled:cursor-not-allowed"
                            disabled>
                            üì± Iniciar Escaneo por Lotes
                        </button>
                    </div>
                </div>
            </div>

            <div id="mensaje" class="mt-4"></div>

            <div id="scanner-container-inventario" class="mt-4" style="display: none;">
                <div id="reader-consulta" class="w-full max-w-lg mx-auto"></div>
                <button id="cerrarEscanerConsulta" class="...">Cerrar Esc√°ner</button>
            </div>

            <button id="generarHojaInventario" class="bg-purple-500 text-white px-4 py-2 mt-4">Generar Hoja de
                Inventario</button>
        </div>

        <!-- Contenido de Inventario por Lotes Avanzado -->
        <div id="contenidoLotesAvanzado" class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4" style="display: none;">
            <!-- Panel de alerta y configuraci√≥n -->
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-yellow-800">Inventario por Lotes Avanzado</h3>
                        <div class="mt-2 text-sm text-yellow-700">
                            <ul class="list-disc list-inside space-y-1">
                                <li>Solo se pueden contar productos con unidad tipo <strong>Kg</strong></li>
                                <li>El escaneo ser√° autom√°tico sin necesidad de b√∫squeda previa</li>
                                <li>Se extraer√°n autom√°ticamente PLU, peso y precio desde c√≥digos CODE128</li>
                                <li>Los productos se agrupar√°n por productos primarios y subproductos</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel de configuraci√≥n -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <h3 class="text-lg font-bold mb-4 text-gray-800">‚öôÔ∏è Configuraci√≥n de Escaneo</h3>
                <div class="space-y-4">
                    <div class="flex items-center">
                        <input type="checkbox" id="confirmarProductosSimilares"
                            class="mr-3 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                        <label for="confirmarProductosSimilares" class="text-sm font-medium text-gray-700">
                            Mostrar ventana de confirmaci√≥n para productos similares
                        </label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="agruparAutomaticamente"
                            class="mr-3 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
                            checked>
                        <label for="agruparAutomaticamente" class="text-sm font-medium text-gray-700">
                            Agrupar autom√°ticamente productos con el mismo PLU
                        </label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="sonidoConfirmacion"
                            class="mr-3 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
                            checked>
                        <label for="sonidoConfirmacion" class="text-sm font-medium text-gray-700">
                            Reproducir sonido de confirmaci√≥n al escanear
                        </label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="relacionarProductos"
                            class="mr-3 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
                            checked>
                        <label for="relacionarProductos" class="text-sm font-medium text-gray-700">
                            Relacionar productos (buscar en productos_subproductos)
                        </label>
                    </div>
                </div>
            </div>

            <!-- Bot√≥n para iniciar escaneo -->
            <div class="text-center mb-6">
                <button id="iniciarEscaneoLotesAvanzado"
                    class="bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-bold py-4 px-8 rounded-lg shadow-lg transform hover:scale-105 transition duration-200">
                    üöÄ Iniciar Escaneo por Lotes Avanzado
                </button>
            </div>

            <!-- MODAL DE SELECCI√ìN KG/PZ (FASE 1) -->
            <div id="modalSeleccionInventario" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white rounded-lg shadow-2xl max-w-md w-full dark-modal max-h-screen overflow-y-auto">
                    <div class="p-4 sm:p-8">
                        <h2 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6 text-center text-gray-800 dark-modal-title">
                            üì¶ Selecciona Tipo
                        </h2>
                        
                        <p class="text-sm sm:text-base text-gray-600 text-center mb-6 sm:mb-8 dark-modal-text">
                            ¬øQu√© tipo de inventario deseas realizar?
                        </p>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                            <!-- Opci√≥n KG -->
                            <button id="btnInventarioKG" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 sm:py-6 px-3 sm:px-4 rounded-lg transition duration-200 transform hover:scale-105 dark-btn-primary text-sm sm:text-base touch-target">
                                <div class="text-2xl sm:text-3xl mb-2">‚öñÔ∏è</div>
                                <div class="font-semibold">Por KG</div>
                                <div class="text-xs text-blue-100 mt-1">Pesaje continuo</div>
                            </button>
                            
                            <!-- Opci√≥n PZ -->
                            <button id="btnInventarioPZ" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-4 sm:py-6 px-3 sm:px-4 rounded-lg transition duration-200 transform hover:scale-105 dark-btn-secondary text-sm sm:text-base touch-target">
                                <div class="text-2xl sm:text-3xl mb-2">üìã</div>
                                <div class="font-semibold">Por PZ</div>
                                <div class="text-xs text-purple-100 mt-1">Por secciones</div>
                            </button>
                        </div>
                        
                        <button id="btnCancelarSeleccion" class="w-full mt-4 sm:mt-6 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded-lg transition duration-200 dark-btn-cancel text-sm sm:text-base touch-target">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>

            <!-- MODAL MODO PZ - INVENTARIO POR SECCIONES Y NIVELES (FASE 2) -->
            <div id="modalInventarioPZ" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto">
                <div class="min-h-screen flex items-center justify-center p-2 sm:p-4">
                    <div class="bg-white rounded-lg shadow-2xl w-full max-w-6xl dark-modal max-h-screen overflow-y-auto">
                        <!-- Encabezado del Modal -->
                        <div class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white p-3 sm:p-6 rounded-t-lg flex justify-between items-start sm:items-center gap-2">
                            <div class="min-w-0 flex-1">
                                <h2 class="text-lg sm:text-3xl font-bold">üìã Inventario PZ</h2>
                                <p id="tituloSeccionNivel" class="text-xs sm:text-sm text-purple-100 mt-1 sm:mt-2">Secci√≥n 1 - Nivel 1</p>
                            </div>
                            <button id="cerrarModalPZ" class="text-white hover:bg-purple-600 p-2 rounded-full transition flex-shrink-0">
                                ‚úï
                            </button>
                        </div>

                        <!-- Contenido del Modal -->
                        <div class="p-3 sm:p-6 space-y-4 sm:space-y-6">
                            <!-- PANEL DE CONTROL (PARTE SUPERIOR) -->
                            <div class="bg-purple-50 p-3 sm:p-4 rounded-lg dark-modal-section">
                                <h3 class="font-bold text-base sm:text-lg text-gray-800 mb-2 sm:mb-3 dark-modal-label">üìä Panel</h3>
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-4">
                                    <div class="bg-white p-2 sm:p-3 rounded border border-purple-200 dark-card">
                                        <p class="text-xs text-gray-600">Secci√≥n</p>
                                        <p id="indicadorSeccion" class="text-lg sm:text-2xl font-bold text-purple-600">1</p>
                                    </div>
                                    <div class="bg-white p-2 sm:p-3 rounded border border-purple-200 dark-card">
                                        <p class="text-xs text-gray-600">Nivel</p>
                                        <p id="indicadorNivel" class="text-lg sm:text-2xl font-bold text-purple-600">1</p>
                                    </div>
                                    <div class="bg-white p-2 sm:p-3 rounded border border-purple-200 dark-card">
                                        <p class="text-xs text-gray-600">Producto #</p>
                                        <p id="indicadorProducto" class="text-lg sm:text-2xl font-bold text-purple-600">1</p>
                                    </div>
                                    <div class="bg-white p-2 sm:p-3 rounded border border-purple-200 dark-card">
                                        <p class="text-xs text-gray-600">Total</p>
                                        <p id="indicadorTotal" class="text-lg sm:text-2xl font-bold text-purple-600">0</p>
                                    </div>
                                </div>
                            </div>

                            <!-- HOJA DE C√ÅLCULO (TABLA VISUAL) -->
                            <div class="bg-gray-50 p-2 sm:p-4 rounded-lg overflow-x-auto dark-modal-section">
                                <h3 class="font-bold text-base sm:text-lg text-gray-800 mb-2 sm:mb-3 dark-modal-label">üìë Hoja</h3>
                                <table class="w-full border-collapse border border-gray-300 dark-modal-table text-xs sm:text-sm">
                                    <thead>
                                        <tr class="bg-purple-200 dark-table-header">
                                            <th class="border border-gray-300 p-1 sm:p-2 text-left font-bold">#</th>
                                            <th class="border border-gray-300 p-1 sm:p-2 text-left font-bold">Producto</th>
                                            <th class="border border-gray-300 p-1 sm:p-2 text-left font-bold">Cant</th>
                                            <th class="border border-gray-300 p-1 sm:p-2 text-left font-bold">Caduc</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaPZ">
                                        <!-- Las filas se generar√°n din√°micamente -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- SECCI√ìN DE ENTRADA DE DATOS -->
                            <div class="bg-indigo-50 p-3 sm:p-6 rounded-lg dark-modal-section">
                                <h3 class="font-bold text-base sm:text-lg text-gray-800 mb-3 sm:mb-4 dark-modal-label">üì• Ingresa Datos</h3>
                                
                                <div class="space-y-4">
                                    <!-- Label din√°mico -->
                                    <label id="labelProducto" class="block text-gray-700 font-semibold dark-modal-label">
                                        Introduce la cantidad del Producto 1
                                    </label>

                                    <!-- Input de Cantidad -->
                                    <div>
                                        <input 
                                            type="number" 
                                            id="inputCantidad"
                                            placeholder="Ej: 5"
                                            min="1"
                                            class="w-full px-4 py-2 border-2 border-indigo-300 rounded-lg focus:border-indigo-500 focus:outline-none bg-white text-gray-900"
                                        />
                                    </div>

                                    <!-- Select de Caducidad -->
                                    <div>
                                        <label class="block text-gray-600 text-sm mb-2">Tipo de Caducidad</label>
                                        <select id="selectCaducidad" class="w-full px-4 py-2 border-2 border-indigo-300 rounded-lg focus:border-indigo-500 focus:outline-none bg-white text-gray-900">
                                            <option value="">Selecciona tipo de caducidad...</option>
                                            <option value="este_mes">üî¥ Este Mes (Prioridad)</option>
                                            <option value="despu√©s_mes">üü° Despu√©s de este Mes (No Importante)</option>
                                        </select>
                                    </div>

                                    <!-- Bot√≥n Siguiente -->
                                    <button id="btnSiguiente" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200 transform hover:scale-105 dark-btn-primary">
                                        ‚ûï Siguiente Producto
                                    </button>
                                </div>
                            </div>

                            <!-- CONTROLES DE NAVEGACI√ìN -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-4">
                                <button id="btnNivelMas1" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200 transform hover:scale-105 dark-btn-secondary text-sm sm:text-base touch-target">
                                    üìà Nivel +1
                                </button>
                                <button id="btnSiguienteSeccion" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200 transform hover:scale-105 dark-btn-success text-sm sm:text-base touch-target">
                                    ‚úÖ Siguiente
                                </button>
                            </div>

                            <!-- Bot√≥n Finalizar Conteo -->
                            <button id="btnFinalizarConteo" class="w-full mt-4 sm:mt-6 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 sm:py-4 px-4 sm:px-6 rounded-lg transition duration-200 transform hover:scale-105 dark-btn-primary text-sm sm:text-base touch-target">
                                üèÅ Finalizar Conteo
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de Esc√°ner PZ (FASE 6) -->
            <div id="modalEscanerPZ" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 z-9998 overflow-y-auto">
                <div class="relative w-full max-w-4xl mx-auto my-8 bg-white rounded-lg shadow-2xl">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 flex justify-between items-center rounded-t-lg">
                        <h2 class="text-2xl font-bold">üîç Escanear Productos</h2>
                        <button id="cerrarModalEscanerPZ" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-full transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Contenido -->
                    <div class="p-6 space-y-6">
                        <!-- Panel de Producto Virtual -->
                        <div class="bg-indigo-50 border-2 border-indigo-300 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-indigo-900 mb-3">üì¶ Producto Virtual Actual</h3>
                            <div class="grid grid-cols-4 gap-4 text-center">
                                <div>
                                    <p class="text-sm text-indigo-600 font-semibold">Producto #</p>
                                    <p id="scanProductoNumero" class="text-2xl font-bold text-indigo-900">-</p>
                                </div>
                                <div>
                                    <p class="text-sm text-indigo-600 font-semibold">Cantidad</p>
                                    <p id="scanProductoCantidad" class="text-2xl font-bold text-indigo-900">-</p>
                                </div>
                                <div>
                                    <p class="text-sm text-indigo-600 font-semibold">Caducidad</p>
                                    <p id="scanProductoCaducidad" class="text-xl font-bold text-indigo-900">-</p>
                                </div>
                                <div>
                                    <p class="text-sm text-indigo-600 font-semibold">Progreso</p>
                                    <p id="scanProgreso" class="text-lg font-bold text-indigo-900">0/0</p>
                                </div>
                            </div>
                        </div>

                        <!-- √Årea de Esc√°ner -->
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-900">üì± Esc√°ner QR/C√≥digo de Barras</h3>
                            <div id="qr-scanner" class="w-full mx-auto bg-gray-100 rounded-lg border-2 border-dashed border-gray-300" style="width: 100%; min-height: 200px; height: 200px; max-height: 30vh; max-width: 100%; overflow: hidden;"></div>
                            
                            <!-- Botones debajo del esc√°ner -->
                            <div class="flex flex-col sm:flex-row justify-center gap-2 sm:gap-3">
                                <button id="btnIniciarEscanerPZ" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition flex-1 sm:flex-none">
                                    ‚ñ∂Ô∏è Iniciar Escaneo
                                </button>
                                <button id="btnPauseEscanerPZ" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg transition hidden flex-1 sm:flex-none">
                                    ‚è∏Ô∏è Pausar
                                </button>
                            </div>
                        </div>

                        <!-- Tarjeta de Producto Escaneado (cuando se detecte) -->
                        <div id="tarjetaProductoEscaneado" style="display: none;" class="bg-green-50 border-2 border-green-300 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-green-900 mb-3">‚úÖ Producto Detectado</h3>
                            <div class="space-y-2 text-gray-800 mb-4">
                                <p><strong>Nombre:</strong> <span id="scanNombreProducto" class="text-green-700 font-semibold">-</span></p>
                                <p><strong>C√≥digo:</strong> <span id="scanCodigoProducto" class="font-mono text-green-700">-</span></p>
                                <p><strong>Marca:</strong> <span id="scanMarcaProducto" class="text-green-700 font-semibold">-</span></p>
                                <p><strong>Categor√≠a:</strong> <span id="scanCategoriaProducto" class="text-green-700 font-semibold">-</span></p>
                            </div>
                            <div class="flex gap-3">
                                <button id="btnConfirmarEscanerPZ" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition">
                                    ‚úÖ Confirmar Escaneo
                                </button>
                                <button id="btnReintentoEscanerPZ" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition">
                                    üîÑ Reintentar
                                </button>
                                <button id="btnSaltarProductoPZ" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">
                                    ‚è≠Ô∏è Saltar
                                </button>
                            </div>
                        </div>

                        <!-- Resumen de Escaneo -->
                        <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">üìä Resumen Escaneo</h3>
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div>
                                    <p class="text-sm text-gray-600 font-semibold">Escaneados</p>
                                    <p id="scanTotalEscaneados" class="text-2xl font-bold text-gray-900">0</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600 font-semibold">Confirmados</p>
                                    <p id="scanTotalConfirmados" class="text-2xl font-bold text-green-600">0</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600 font-semibold">Rechazados</p>
                                    <p id="scanTotalRechazados" class="text-2xl font-bold text-red-600">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="bg-gray-100 p-6 rounded-b-lg flex justify-between">
                        <button id="btnCancelarEscanerPZ" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition">
                            ‚ùå Cancelar
                        </button>
                        <button id="btnFinalizarEscanerPZ" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition" disabled>
                            ‚úÖ Finalizar Escaneo
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal: Producto No Encontrado -->
            <div id="modalProductoNoEncontrado" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 z-9999 flex items-center justify-center">
                <div class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4">
                    <!-- Header -->
                    <div class="bg-red-600 text-white p-6 rounded-t-lg">
                        <h2 class="text-2xl font-bold">‚ùå Producto No Encontrado</h2>
                    </div>
                    
                    <!-- Contenido -->
                    <div class="p-6 space-y-4">
                        <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4">
                            <p class="text-red-900 font-semibold">El c√≥digo no existe en el sistema:</p>
                            <p id="codigoNoEncontrado" class="font-mono text-lg text-red-700 mt-2">-</p>
                        </div>
                        
                        <p class="text-gray-700 text-center">¬øQu√© deseas hacer?</p>
                    </div>
                    
                    <!-- Botones -->
                    <div class="bg-gray-100 p-6 rounded-b-lg space-y-3">
                        <button id="btnReintentoProductoNoEncontrado" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition">
                            üîÑ Reintentar Escaneo
                        </button>
                        <button id="btnRegistrarProductoNoEncontrado" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg transition">
                            ‚ûï Registrar Producto
                        </button>
                        <button id="btnSaltarProductoNoEncontrado" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition">
                            ‚è≠Ô∏è Saltar Producto
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal: Registrar Producto R√°pido -->
            <div id="modalRegistrarProductoRapido" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 z-10000 flex items-center justify-center">
                <div class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4 max-h-screen overflow-y-auto">
                    <!-- Header -->
                    <div class="bg-orange-600 text-white p-6 rounded-t-lg sticky top-0">
                        <h2 class="text-2xl font-bold">‚ûï Registrar Producto</h2>
                    </div>
                    
                    <!-- Formulario -->
                    <form id="formRegistrarProductoRapido" class="p-6 space-y-4">
                        <!-- C√≥digo (readonly) -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                üè∑Ô∏è C√≥digo de Barras (No editable)
                            </label>
                            <input id="inputCodigoProductoRapido" type="text" readonly class="w-full px-4 py-2 bg-gray-100 border-2 border-gray-300 rounded-lg text-gray-700 font-mono" placeholder="-">
                        </div>
                        
                        <!-- Nombre -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                üìù Nombre del Producto *
                            </label>
                            <input id="inputNombreProductoRapido" type="text" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none transition" placeholder="Ej: Electrolit" required>
                        </div>
                        
                        <!-- Marca -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                üè¢ Marca
                            </label>
                            <input id="inputMarcaProductoRapido" type="text" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none transition" placeholder="Ej: Prueba">
                        </div>
                        
                        <!-- Categor√≠a -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                üìÇ Categor√≠a
                            </label>
                            <input id="inputCategoriaProductoRapido" type="text" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none transition" placeholder="Ej: Bebidas">
                        </div>
                        
                        <!-- Unidad -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                üìè Unidad
                            </label>
                            <select id="selectUnidadProductoRapido" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none transition">
                                <option value="Pz" selected>Pz (Pieza)</option>
                                <option value="Kg">Kg (Kilogramo)</option>
                                <option value="Lt">Lt (Litro)</option>
                                <option value="Caja">Caja</option>
                                <option value="Paquete">Paquete</option>
                            </select>
                        </div>
                        
                        <p class="text-xs text-gray-500 text-center">(*) Campos requeridos</p>
                    </form>
                    
                    <!-- Botones -->
                    <div class="bg-gray-100 p-6 rounded-b-lg sticky bottom-0 space-y-2 flex gap-3">
                        <button id="btnCancelarRegistroRapido" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">
                            ‚ùå Cancelar
                        </button>
                        <button id="btnGuardarProductoRapido" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition">
                            ‚úÖ Guardar y Reescanear
                        </button>
                    </div>
                </div>
            </div>

            <!-- √Årea de resultados de productos escaneados -->
            <div id="resultadosLotesAvanzado" class="hidden">
                <h3 class="text-lg font-bold mb-4 text-gray-800">üìä Productos Escaneados</h3>
                <div id="contenedorProductosPrimarios" class="space-y-4">
                    <!-- Las tarjetas de productos primarios se mostrar√°n aqu√≠ -->
                </div>

                <!-- Bot√≥n para guardar inventario -->
                <div class="text-center mt-6">
                    <button id="guardarInventarioLotesAvanzado"
                        class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg disabled:bg-gray-300 disabled:cursor-not-allowed"
                        disabled>
                        üíæ Guardar Inventario
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Escaneo por Lotes Avanzado -->
        <div id="modalEscaneoLotesAvanzado"
            class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
            <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-5xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <!-- Header del modal -->
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">üöÄ Escaneo por Lotes Avanzado</h3>
                        <button id="cerrarModalLotesAvanzado" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Pesta√±as del modal -->
                    <div class="flex border-b mb-4">
                        <button id="tabEscanerAvanzado"
                            class="px-4 py-2 bg-blue-500 text-white rounded-t-lg border-b-2 border-blue-500">
                            üì± Esc√°ner
                        </button>
                        <button id="tabListadoAvanzado"
                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-t-lg ml-2 hover:bg-gray-300">
                            üìã Productos Escaneados (<span id="contadorProductosAvanzado">0</span>)
                        </button>
                    </div>

                    <!-- Contenido del esc√°ner -->
                    <div id="contenidoEscanerAvanzado" class="mb-4">
                        <div id="scanner-container-lotes-avanzado" class="mb-4">
                            <div id="reader-lotes-avanzado" class="w-full max-w-lg mx-auto"></div>
                        </div>
                        <div class="text-center">
                            <button id="accionEscaneoLotesAvanzado"
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded font-bold"
                                style="user-select:none;">
                                Activar esc√°ner
                            </button>
                        </div>
                    </div>

                    <!-- Contenido del listado -->
                    <div id="contenidoListadoAvanzado" style="display: none;">
                        <div class="max-h-96 overflow-y-auto">
                            <table class="w-full bg-white shadow-md rounded">
                                <thead class="bg-gray-200">
                                    <tr>
                                        <th class="py-2 px-4 text-left">#</th>
                                        <th class="py-2 px-4 text-left">C√≥digo</th>
                                        <th class="py-2 px-4 text-left">PLU</th>
                                        <th class="py-2 px-4 text-left">Nombre</th>
                                        <th class="py-2 px-4 text-left">Peso (Kg)</th>
                                        <th class="py-2 px-4 text-left">Precio/Kg</th>
                                        <th class="py-2 px-4 text-left">Precio Porci√≥n</th>
                                        <th class="py-2 px-4 text-left">Tipo</th>
                                        <th class="py-2 px-4 text-left">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="listadoProductosAvanzado">
                                    <!-- Los productos escaneados aparecer√°n aqu√≠ -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Footer del modal -->
                    <div class="mt-6 flex justify-between items-center">
                        <div class="text-sm text-gray-600">
                            Total productos: <span id="totalProductosAvanzado" class="font-bold">0</span> |
                            Peso total: <span id="pesoTotalAvanzado" class="font-bold">0.000 Kg</span> |
                            Productos primarios: <span id="totalProductosPrimarios" class="font-bold">0</span>
                        </div>
                        <button id="finalizarEscaneoLotesAvanzado"
                            class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded disabled:bg-gray-300 disabled:cursor-not-allowed"
                            disabled>
                            ‚úÖ Finalizar Escaneo por Lotes Avanzado
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Edici√≥n de Producto de Lote -->
        <div id="modalEdicionProductoLote" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full"
            style="display: none; z-index: 10000;">
            <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-md shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <!-- Header del modal -->
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900">‚úèÔ∏è Editar Producto Escaneado</h3>
                        <button onclick="cerrarModalEdicionProducto()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Informaci√≥n del producto -->
                    <div class="mb-4 p-3 bg-gray-50 rounded">
                        <p class="text-sm"><strong>Producto:</strong> <span id="editProductoNombre" class="font-medium"></span></p>
                        <p class="text-sm"><strong>C√≥digo:</strong> <span id="editProductoCodigo" class="font-mono"></span></p>
                        <p class="text-sm"><strong>PLU:</strong> <span id="editProductoPLU" class="font-mono"></span></p>
                        <input type="hidden" id="editProductoId">
                    </div>

                    <!-- Campos editables -->
                    <div class="space-y-4">
                        <!-- Precio por Kilo -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                üí∞ Precio por Kilo ($)
                            </label>
                            <input type="number" id="editPrecioKilo" step="0.01" min="0.01"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="0.00">
                            <p class="text-xs text-gray-500 mt-1">
                                üí° Modifica si el precio por kilo era diferente al momento de crear la etiqueta
                            </p>
                        </div>

                        <!-- Peso -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                ‚öñÔ∏è Peso (Kg)
                            </label>
                            <input type="number" id="editPeso" step="0.001" min="0.001"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="0.000">
                            <p class="text-xs text-gray-500 mt-1">
                                üí° Modifica si el peso calculado no es correcto (recalcula precio autom√°ticamente)
                            </p>
                        </div>

                        <!-- Precio de Porci√≥n (solo lectura, se actualiza autom√°ticamente) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                üè∑Ô∏è Precio de Porci√≥n ($)
                            </label>
                            <input type="number" id="editPrecioPorcion" step="0.01" min="0.01" readonly
                                class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed"
                                placeholder="0.00">
                            <p class="text-xs text-gray-500 mt-1">
                                ‚ÑπÔ∏è Se calcula autom√°ticamente: Precio/Kg √ó Peso
                            </p>
                        </div>
                    </div>

                    <!-- Footer del modal -->
                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="cerrarModalEdicionProducto()"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                            Cancelar
                        </button>
                        <button onclick="guardarEdicionProducto()"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                            üíæ Guardar Cambios
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Informaci√≥n de Producto -->
        <div id="modalInfoProducto" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full"
            style="display: none; z-index: 9999;">
            <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <!-- Header del modal -->
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900">üìã Informaci√≥n del Producto</h3>
                        <button id="cerrarModalInfoProducto" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Contenido del modal -->
                    <div id="contenidoInfoProducto">
                        <!-- Se llenar√° din√°micamente -->
                    </div>

                    <!-- Footer del modal -->
                    <div class="mt-6 flex justify-end space-x-3">
                        <button id="cancelarInfoProducto"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                            Cancelar
                        </button>
                        <button id="guardarInfoProducto"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded disabled:bg-gray-300 disabled:cursor-not-allowed"
                            disabled>
                            Guardar Info
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Escaneo por Lotes (original) -->
        <div id="modalEscaneoLotes" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
            style="display: none;">
            <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <!-- Header del modal -->
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900">Escaneo por Lotes</h3>
                        <button id="cerrarModalLotes" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                        </button>
                    </div>

                    <!-- Pesta√±as del modal -->
                    <div class="flex border-b mb-4">
                        <button id="tabEscaner"
                            class="px-4 py-2 bg-blue-500 text-white rounded-t-lg border-b-2 border-blue-500">
                            üì± Esc√°ner
                        </button>
                        <button id="tabListado"
                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-t-lg ml-2 hover:bg-gray-300">
                            üìã C√≥digos Escaneados (<span id="contadorCodigos">0</span>)
                        </button>
                    </div>

                    <!-- Contenido del esc√°ner -->
                    <div id="contenidoEscaner" class="mb-4">
                        <div id="scanner-container-lotes" class="mb-4">
                            <div id="reader-lotes" class="w-full max-w-lg mx-auto"></div>
                        </div>
                        <div class="text-center">
                            <button id="pararEscaneoLotes"
                                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                                Pausar Esc√°ner
                            </button>
                        </div>
                    </div>

                    <!-- Contenido del listado -->
                    <div id="contenidoListado" style="display: none;">
                        <div class="max-h-96 overflow-y-auto">
                            <table class="w-full bg-white shadow-md rounded">
                                <thead class="bg-gray-200">
                                    <tr>
                                        <th class="py-2 px-4 text-left">#</th>
                                        <th class="py-2 px-4 text-left">C√≥digo Completo</th>
                                        <th class="py-2 px-4 text-left">PLU</th>
                                        <th class="py-2 px-4 text-left">Peso (Kg)</th>
                                        <th class="py-2 px-4 text-left">Precio Porci√≥n</th>
                                        <th class="py-2 px-4 text-left">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="listadoCodigosEscaneados">
                                    <!-- Los c√≥digos escaneados aparecer√°n aqu√≠ -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Footer del modal -->
                    <div class="mt-6 flex justify-between items-center">
                        <div class="text-sm text-gray-600">
                            Total de c√≥digos: <span id="totalCodigos" class="font-bold">0</span> |
                            Peso total: <span id="pesoTotal" class="font-bold">0.00 Kg</span> |
                            Valor total porciones: <span id="precioTotalGeneral" class="font-bold">$0.00</span>
                        </div>
                        <button id="finalizarEscaneoLotes"
                            class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded disabled:bg-gray-300 disabled:cursor-not-allowed"
                            disabled>
                            ‚úÖ Finalizar Escaneo por Lotes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- tabla de productos en inventario -->
    <div>
        <button id="sync-inventario-down-btn"
            class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">
            Sincronizar Inventario desde Supabase
        </button>
        <button id="sincronizarManual" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
            Sincronizar Ahora
        </button>
        
        <!-- Contenedor para el Reporte de Escaneo (FASE 7) -->
        <div id="reporteContenedor" class="my-8"></div>
        
        <h2 class="text-2xl font-bold mt-8 mb-4"> Productos en Inventario </h2>
        <div class="overflow-x-auto">
            <table id="estructura-plantilla" class="table-auto w-full bg-white shadow-md rounded">
                <thead>
                    <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                        <th class="py-3 px-6 text-left">C√≥digo</th>
                        <th class="py-3 px-6 text-left">Nombre</th>
                        <th class="py-3 px-6 text-left">Categor√≠a</th>
                        <th class="py-3 px-6 text-left">Marca</th>
                        <th class="py-3 px-6 text-left">Tipo de Cantidad</th>
                        <th class="py-3 px-6 text-left">Cantidad</th>
                        <th class="py-3 px-6 text-left">Fecha de Caducidad</th>
                        <th class="py-3 px-6 text-left">Comentarios</th>
                        <th class="py-3 px-6 text-left">ubicacion</th>
                    </tr>
                </thead>
                <tbody id="estructuraPlantillaBody" class="text-gray-600 text-sm font-light">
                    <!-- Data will be dynamically populated here -->
                </tbody>
            </table>
        </div>
    </div>
    <script src="../librer√≠as/html5-qrcode.min.js"></script>
    <script src="../js/ui/mobile-optimizer.js"></script>
    <script src="../js/ui/table-mobile-optimizer.js"></script>
    <script type="module" src="../js/scanner/lotes-avanzado.js"></script>
    <script type="module" src="../js/core/main.js"></script>
    <script>
        // Funci√≥n para convertir gui√≥n a 6 ceros
        function convertirGuionACeros(valor) {
            return valor.replace(/-/g, '000000');
        }

        // Funci√≥n para aplicar la conversi√≥n a un input
        function aplicarConversionCodigo(input) {
            if (!input) return;

            input.addEventListener('input', function (e) {
                const valorOriginal = e.target.value;
                const valorConvertido = convertirGuionACeros(valorOriginal);

                if (valorOriginal !== valorConvertido) {
                    const cursorPos = e.target.selectionStart;
                    e.target.value = valorConvertido;

                    const diferencia = valorConvertido.length - valorOriginal.length;
                    const nuevaPosicion = Math.min(cursorPos + diferencia, valorConvertido.length);
                    e.target.setSelectionRange(nuevaPosicion, nuevaPosicion);
                }
            });

            input.addEventListener('blur', function (e) {
                e.target.value = convertirGuionACeros(e.target.value);
            });
        }

        // Aplicar conversi√≥n a los campos de c√≥digo cuando se cargue la p√°gina
        document.addEventListener('DOMContentLoaded', function () {
            const codigo = document.getElementById('codigo');
            const codigoProductoInventario = document.getElementById('codigoProductoInventario');

            aplicarConversionCodigo(codigo);
            // Note: codigoProductoInventario es readonly, pero aplicamos por si acaso
            aplicarConversionCodigo(codigoProductoInventario);
        });
    </script>
</body>

</html>