<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Migraci√≥n - Gestor Inventory</title>
    <!-- ‚ö° MIGRACI√ìN: Archivo de prueba para verificar servicios migrados -->
    
    <link rel="stylesheet" href="./librer√≠as/tailwind.min.css">
    <script src="./librer√≠as/sweetalert2@11.js"></script>
    <link rel="stylesheet" href="./css/styles.css">
    
    <style>
        .status-success { color: #10b981; }
        .status-error { color: #ef4444; }
        .status-pending { color: #f59e0b; }
        .test-result { 
            margin: 8px 0; 
            padding: 8px 12px; 
            border-radius: 4px; 
            border-left: 4px solid #e5e7eb;
        }
        .test-success { 
            background-color: #f0fdf4; 
            border-left-color: #10b981; 
        }
        .test-error { 
            background-color: #fef2f2; 
            border-left-color: #ef4444; 
        }
        .test-pending { 
            background-color: #fffbeb; 
            border-left-color: #f59e0b; 
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center">üß™ Prueba de Migraci√≥n</h1>
        <p class="text-center text-gray-600 mb-8">Verificando que los servicios migrados funcionen correctamente</p>
        
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Estado de la Migraci√≥n</h2>
            
            <div id="test-results">
                <div class="test-result test-pending">
                    <strong>üì¶ Carga de Bridges:</strong> 
                    <span id="bridges-status" class="status-pending">Pendiente...</span>
                </div>
                
                <div class="test-result test-pending">
                    <strong>üîß Servicios Core:</strong> 
                    <span id="services-status" class="status-pending">Pendiente...</span>
                </div>
                
                <div class="test-result test-pending">
                    <strong>üîÑ Compatibilidad Legacy:</strong> 
                    <span id="compatibility-status" class="status-pending">Pendiente...</span>
                </div>
                
                <div class="test-result test-pending">
                    <strong>üì± Funcionalidades:</strong> 
                    <span id="functionality-status" class="status-pending">Pendiente...</span>
                </div>
            </div>
            
            <div class="mt-6 flex gap-4">
                <button id="run-tests" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">
                    üöÄ Ejecutar Pruebas
                </button>
                
                <button id="reload-page" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded">
                    üîÑ Recargar P√°gina
                </button>
            </div>
            
            <div id="detailed-results" class="mt-6 hidden">
                <h3 class="text-lg font-semibold mb-3">Resultados Detallados</h3>
                <div id="detailed-output" class="bg-gray-50 p-4 rounded text-sm font-mono whitespace-pre-wrap"></div>
            </div>
        </div>
        
        <div class="mt-8 text-center">
            <a href="./index.html" class="text-blue-600 hover:text-blue-800">‚Üê Volver al Login</a>
            <span class="mx-4">|</span>
            <a href="./plantillas/main.html" class="text-blue-600 hover:text-blue-800">Ir al Dashboard ‚Üí</a>
        </div>
    </div>
    
    <script type="module">
        // Variables globales para resultados
        let testResults = {
            bridges: false,
            services: false,
            compatibility: false,
            functionality: false
        };
        
        let detailedOutput = [];
        
        function log(message, type = 'info') {
            console.log(message);
            detailedOutput.push(`[${new Date().toISOString()}] ${message}`);
            
            // Actualizar el output detallado
            const outputElement = document.getElementById('detailed-output');
            if (outputElement) {
                outputElement.textContent = detailedOutput.join('\\n');
            }
        }
        
        function updateStatus(testId, success, message) {
            const statusElement = document.getElementById(`${testId}-status`);
            const containerElement = statusElement.closest('.test-result');
            
            if (success) {
                statusElement.textContent = '‚úÖ ' + message;
                statusElement.className = 'status-success';
                containerElement.className = 'test-result test-success';
            } else {
                statusElement.textContent = '‚ùå ' + message;
                statusElement.className = 'status-error';
                containerElement.className = 'test-result test-error';
            }
        }
        
        async function testBridges() {
            log('üß™ Iniciando prueba de bridges...');
            
            try {
                // Probar db-operations-bridge
                log('üì¶ Cargando db-operations-bridge...');
                const dbBridge = await import('./js/db-operations-bridge.js');
                log(`‚úÖ db-operations-bridge cargado (${Object.keys(dbBridge).length} exportaciones)`);
                
                // Probar product-operations-bridge
                log('üì¶ Cargando product-operations-bridge...');
                const productBridge = await import('./js/product-operations-bridge.js');
                log(`‚úÖ product-operations-bridge cargado (${Object.keys(productBridge).length} exportaciones)`);
                
                testResults.bridges = true;
                updateStatus('bridges', true, 'Cargados correctamente');
                return true;
                
            } catch (error) {
                log(`‚ùå Error cargando bridges: ${error.message}`);
                updateStatus('bridges', false, 'Error en la carga');
                return false;
            }
        }
        
        async function testServices() {
            log('üß™ Iniciando prueba de servicios...');
            
            try {
                // Intentar cargar ServiceManager
                log('üîß Cargando ServiceManager...');
                const { ServiceManager } = await import('./src/core/services/ServiceManager.js');
                log('‚úÖ ServiceManager cargado');
                
                // Intentar cargar algunos repositorios
                log('üóÑÔ∏è Cargando repositorios...');
                const { ProductRepository } = await import('./src/core/repositories/ProductRepository.js');
                const { InventoryRepository } = await import('./src/core/repositories/InventoryRepository.js');
                log('‚úÖ Repositorios cargados');
                
                testResults.services = true;
                updateStatus('services', true, 'Servicios disponibles');
                return true;
                
            } catch (error) {
                log(`‚ùå Error cargando servicios: ${error.message}`);
                updateStatus('services', false, 'Error en servicios');
                return false;
            }
        }
        
        async function testCompatibility() {
            log('üß™ Iniciando prueba de compatibilidad...');
            
            try {
                // Verificar que las funciones legacy est√©n disponibles
                const dbBridge = await import('./js/db-operations-bridge.js');
                
                // Probar algunas funciones b√°sicas
                if (typeof dbBridge.inicializarDB === 'function') {
                    log('‚úÖ inicializarDB disponible');
                }
                
                if (typeof dbBridge.db !== 'undefined') {
                    log('‚úÖ Variable db disponible');
                }
                
                testResults.compatibility = true;
                updateStatus('compatibility', true, 'Legacy functions disponibles');
                return true;
                
            } catch (error) {
                log(`‚ùå Error en compatibilidad: ${error.message}`);
                updateStatus('compatibility', false, 'Problemas de compatibilidad');
                return false;
            }
        }
        
        async function testFunctionality() {
            log('üß™ Iniciando prueba de funcionalidad...');
            
            try {
                // Verificar que window tenga las funciones esperadas
                if (typeof window !== 'undefined') {
                    log('‚úÖ Entorno del navegador detectado');
                }
                
                // Verificar localStorage
                if (typeof localStorage !== 'undefined') {
                    log('‚úÖ localStorage disponible');
                }
                
                // Verificar que SweetAlert est√© cargado
                if (typeof Swal !== 'undefined') {
                    log('‚úÖ SweetAlert2 disponible');
                }
                
                testResults.functionality = true;
                updateStatus('functionality', true, 'Funciones b√°sicas OK');
                return true;
                
            } catch (error) {
                log(`‚ùå Error en funcionalidad: ${error.message}`);
                updateStatus('functionality', false, 'Problemas de funcionalidad');
                return false;
            }
        }
        
        async function runAllTests() {
            log('üöÄ Iniciando suite completa de pruebas...');
            log('üìÖ Fecha: ' + new Date().toISOString());
            
            // Mostrar el √°rea de resultados detallados
            document.getElementById('detailed-results').classList.remove('hidden');
            
            // Ejecutar pruebas secuencialmente
            await testBridges();
            await testServices();
            await testCompatibility();
            await testFunctionality();
            
            // Calcular resultado final
            const allPassed = Object.values(testResults).every(result => result);
            
            log('');
            log('=== RESUMEN FINAL ===');
            log(`Bridges: ${testResults.bridges ? '‚úÖ PAS√ì' : '‚ùå FALL√ì'}`);
            log(`Servicios: ${testResults.services ? '‚úÖ PAS√ì' : '‚ùå FALL√ì'}`);
            log(`Compatibilidad: ${testResults.compatibility ? '‚úÖ PAS√ì' : '‚ùå FALL√ì'}`);
            log(`Funcionalidad: ${testResults.functionality ? '‚úÖ PAS√ì' : '‚ùå FALL√ì'}`);
            log('');
            
            if (allPassed) {
                log('üéâ ¬°TODAS LAS PRUEBAS PASARON!');
                log('‚úÖ La migraci√≥n est√° funcionando correctamente');
                log('‚úÖ La aplicaci√≥n est√° lista para usar los servicios migrados');
                
                // Mostrar notificaci√≥n de √©xito
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: '¬°√âxito!',
                        text: 'La migraci√≥n est√° funcionando correctamente',
                        icon: 'success',
                        timer: 3000
                    });
                }
            } else {
                log('‚ö†Ô∏è ALGUNAS PRUEBAS FALLARON');
                log('üîß Revise los errores anteriores para m√°s informaci√≥n');
                
                // Mostrar notificaci√≥n de error
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: 'Problemas Detectados',
                        text: 'Algunas pruebas fallaron. Revise la consola.',
                        icon: 'warning'
                    });
                }
            }
            
            return allPassed;
        }
        
        // Configurar event listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('run-tests').addEventListener('click', runAllTests);
            
            document.getElementById('reload-page').addEventListener('click', () => {
                window.location.reload();
            });
        });
        
        // Ejecutar una prueba b√°sica al cargar
        setTimeout(() => {
            log('üí° P√°gina cargada. Haga clic en "üöÄ Ejecutar Pruebas" para comenzar.');
        }, 500);
    </script>
</body>
</html>
