# Repositorios - Documentaci√≥n y Ejemplos de Uso

## üìã Descripci√≥n General

Los repositorios implementan el patr√≥n Repository para abstraer el acceso a datos. Proporcionan una interfaz uniforme para operaciones CRUD, sincronizaci√≥n offline/online y manejo de datos tanto en IndexedDB como en Supabase.

## üèóÔ∏è Arquitectura

```
BaseRepository (abstracto)
‚îú‚îÄ‚îÄ InventoryRepository
‚îú‚îÄ‚îÄ ProductRepository
‚îî‚îÄ‚îÄ [Futuros repositorios...]

Dependencias:
‚îú‚îÄ‚îÄ IndexedDBAdapter    # Abstracci√≥n de IndexedDB
‚îú‚îÄ‚îÄ SyncQueue          # Cola de sincronizaci√≥n
‚îî‚îÄ‚îÄ Models             # Validaci√≥n de datos
```

## üìö Repositorios Disponibles

### InventoryRepository
Gestiona el inventario de productos con lotes y cantidades.

### ProductRepository  
Gestiona el cat√°logo de productos y sincronizaci√≥n con FastAPI.

## üîß Uso B√°sico

### Inicializaci√≥n
```javascript
import { InventoryRepository, ProductRepository } from '../core/repositories/index.js';

// Crear instancias
const inventoryRepo = new InventoryRepository();
const productRepo = new ProductRepository();

// Inicializar bases de datos
await inventoryRepo.initializeDatabase();
await productRepo.initializeDatabase();
```

### Operaciones CRUD

#### Crear Registros
```javascript
// Crear producto
const producto = await productRepo.create({
    codigo: 'PROD001',
    nombre: 'Producto de Prueba',
    categoria: 'Categoria A',
    marca: 'Marca Test',
    unidad: 'pcs',
    precio: 10.50
});

// Crear item de inventario
const inventario = await inventoryRepo.create({
    codigo: 'PROD001',
    nombre: 'Producto de Prueba',
    lote: 'LOTE001',
    cantidad: 100,
    unidad: 'pcs',
    caducidad: '2025-12-31'
});
```

#### Leer Registros
```javascript
// Buscar producto por c√≥digo
const producto = await productRepo.findByCodigo('PROD001');

// Buscar inventario por c√≥digo y lote
const inventario = await inventoryRepo.findByCodigoAndLote('PROD001', 'LOTE001');

// Obtener todos los productos
const productos = await productRepo.findAll();

// Buscar con filtros
const productosCategoria = await productRepo.findAll({
    categoria: 'Categoria A'
});
```

#### Actualizar Registros
```javascript
// Actualizar producto
const productoActualizado = await productRepo.update('PROD001', {
    precio: 12.00,
    descripcion: 'Descripci√≥n actualizada'
});

// Actualizar cantidad en inventario
const inventarioActualizado = await inventoryRepo.updateQuantity(
    'inventory-id',
    150,
    'Restock mensual'
);
```

#### Eliminar Registros
```javascript
// Eliminar producto
await productRepo.delete('PROD001');

// Eliminar item de inventario
await inventoryRepo.delete('inventory-id');
```

## üîÑ Sincronizaci√≥n

### Sincronizaci√≥n Autom√°tica
Los repositorios manejan sincronizaci√≥n autom√°tica entre IndexedDB y los backends:

```javascript
// La sincronizaci√≥n ocurre autom√°ticamente en:
// - Operaciones CRUD cuando hay conexi√≥n
// - Cuando se detecta conexi√≥n de red
// - Al procesar la cola de sincronizaci√≥n

// Sincronizaci√≥n manual
await inventoryRepo.syncFromSupabase();
await productRepo.syncWithFastAPI();
```

### Trabajo Offline
```javascript
// Las operaciones funcionan offline autom√°ticamente
const producto = await productRepo.create({
    codigo: 'OFFLINE001',
    nombre: 'Producto Offline'
});
// Se guarda localmente y se sincroniza cuando hay conexi√≥n
```

## üìä Operaciones Avanzadas

### Gesti√≥n de Stock
```javascript
// Obtener stock total por c√≥digo
const stockTotal = await inventoryRepo.getStockByCodigo('PROD001');

// Buscar items con stock bajo
const stockBajo = await inventoryRepo.findLowStock(10);

// Buscar items pr√≥ximos a caducar
const proximosCaducar = await inventoryRepo.findExpiringItems(30);
```

### Estad√≠sticas e Informes
```javascript
// Resumen de inventario
const resumen = await inventoryRepo.getInventorySummary();
console.log(`Total items: ${resumen.totalItems}`);
console.log(`Valor total: $${resumen.totalValor}`);

// Estad√≠sticas de productos
const stats = await productRepo.getStatistics();
console.log(`Productos por categor√≠a:`, stats.porCategoria);
```

### B√∫squedas Avanzadas
```javascript
// B√∫squeda con m√∫ltiples filtros
const productos = await productRepo.searchWithFilters({
    categoria: 'Electr√≥nicos',
    marca: 'Samsung',
    nombre: 'smartphone'
});

// Buscar por c√≥digo parcial
const coincidencias = await productRepo.findByCodigoParcial('SAM');
```

### Exportaci√≥n de Datos
```javascript
// Exportar a CSV
const csvInventario = await inventoryRepo.exportToCSV({
    categoria: 'Categoria A'
});

const csvProductos = await productRepo.exportToCSV();

// Crear archivo y descargar
const blob = new Blob([csvInventario], { type: 'text/csv' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = 'inventario.csv';
a.click();
```

## üß™ Testing

### Configurar Mocks
```javascript
import { InventoryRepository } from '../core/repositories/InventoryRepository.js';

// Mock IndexedDB
global.indexedDB = {
    open: jest.fn(() => ({
        onsuccess: null,
        onerror: null,
        result: mockDB
    }))
};

// Mock Supabase
const mockSupabase = {
    from: jest.fn(() => ({
        select: jest.fn(() => ({ data: [], error: null }))
    }))
};
```

### Tests de Ejemplo
```javascript
describe('InventoryRepository', () => {
    let repository;
    
    beforeEach(() => {
        repository = new InventoryRepository();
        // Setup mocks...
    });
    
    test('should create inventory item', async () => {
        const data = {
            codigo: 'TEST001',
            cantidad: 10
        };
        
        const result = await repository.create(data);
        expect(result.codigo).toBe('TEST001');
    });
});
```

## ‚ö†Ô∏è Consideraciones Importantes

### Manejo de Errores
```javascript
try {
    const producto = await productRepo.create(data);
} catch (error) {
    if (error.message.includes('Ya existe')) {
        console.log('Producto duplicado');
    } else {
        console.error('Error inesperado:', error);
    }
}
```

### Performance
```javascript
// Usar transacciones para operaciones m√∫ltiples
await inventoryRepo.dbAdapter.transaction(['inventario'], 'readwrite', (stores) => {
    // M√∫ltiples operaciones en una transacci√≥n
});

// Batch operations para grandes vol√∫menes
const productos = [...]; // Array grande
for (const batch of chunks(productos, 100)) {
    await Promise.all(batch.map(p => productRepo.create(p)));
}
```

### Limpieza de Recursos
```javascript
// Cerrar conexiones cuando sea necesario
inventoryRepo.dbAdapter.close();
productRepo.dbAdapter.close();
```

## üîß Configuraci√≥n Avanzada

### Personalizar Configuraci√≥n
```javascript
import { RepositoryConfig } from '../core/repositories/index.js';

// Modificar configuraci√≥n global
RepositoryConfig.syncRetry.maxRetries = 5;
RepositoryConfig.cache.ttl = 600000; // 10 minutos
```

### Factory Pattern
```javascript
import { RepositoryFactory } from '../core/repositories/index.js';

// Usar factory para crear instancias
const repos = RepositoryFactory.getAllRepositories();
const inventario = repos.inventory;
const productos = repos.product;
```

## üìù Migraci√≥n desde C√≥digo Legacy

### Reemplazar db-operations.js
```javascript
// ANTES (db-operations.js)
import { sincronizarInventarioDesdeSupabase } from './db-operations.js';
const datos = await sincronizarInventarioDesdeSupabase();

// DESPU√âS (InventoryRepository)
import { InventoryRepository } from '../core/repositories/InventoryRepository.js';
const repo = new InventoryRepository();
await repo.initializeDatabase();
const datos = await repo.syncFromSupabase();
```

### Reemplazar product-operations.js
```javascript
// ANTES (product-operations.js)
import { buscarProducto } from './product-operations.js';
const producto = await buscarProducto(codigo);

// DESPU√âS (ProductRepository)
import { ProductRepository } from '../core/repositories/ProductRepository.js';
const repo = new ProductRepository();
await repo.initializeDatabase();
const producto = await repo.findByCodigo(codigo);
```

## üöÄ Pr√≥ximos Pasos

1. **BatchRepository** - Para gesti√≥n avanzada de lotes
2. **TransactionRepository** - Para movimientos de inventario
3. **UserRepository** - Para gesti√≥n de usuarios
4. **CategoryRepository** - Para gesti√≥n de categor√≠as
5. **ReportRepository** - Para reportes y anal√≠tica

## üìû Soporte

Para dudas o problemas con los repositorios:
- Revisar logs en console del navegador
- Verificar configuraci√≥n de IndexedDB
- Comprobar conectividad con Supabase/FastAPI
- Consultar tests unitarios para ejemplos de uso
