<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generar Informe de Inventario con Códigos de Barras</title>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .producto-input {
      margin-bottom: 10px;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }

    /* Estilo para la ventana modal */
    #loading-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #loading-modal.hidden {
      display: none;
    }
    #loading-modal p {
      color: white;
      font-size: 20px;
      text-align: center;
    }
    #progress-bar-container {
      width: 80%;
      margin-top: 20px;
    }
    #progress-bar {
      width: 0%;
      height: 20px;
      background-color: #4caf50;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <!-- Ventana modal de carga -->
  <div id="loading-modal">
    <p id="loading-message">Cargando dependencias... Por favor, espera.</p>
    <div id="progress-bar-container">
      <div id="progress-bar"></div>
    </div>
  </div>

  <h1>Generar Informe de Inventario con Códigos de Barras</h1>

  <!-- Formulario para cargar CSV -->
  <div id="formulario-csv">
    <label for="csv-file">Cargar archivo CSV:</label>
    <input type="file" id="csv-file" accept=".csv" />
    <button onclick="cargarCSV()">Cargar Productos desde CSV</button>
  </div>

  <!-- Lista de productos agregados -->
  <h2>Productos Agregados</h2>
  <ul id="lista-productos"></ul>

  <!-- Botón para generar el PDF -->
  <button onclick="generarPDF()">Generar PDF</button>

  <script>
    // Usar un Map para almacenar los productos
    const inventario = new Map();

    // Función para actualizar la barra de progreso
    function actualizarProgressBar(progreso, mensaje) {
      const progressBar = document.getElementById("progress-bar");
      const loadingMessage = document.getElementById("loading-message");
      progressBar.style.width = `${progreso}%`;
      loadingMessage.textContent = mensaje;
    }
    // Cuando se carga el archivo CSV
    document.getElementById('csv-file').addEventListener('change', function(event) {
      const csvFile = event.target.files[0];
      const csvFileName = csvFile.name.split('.').slice(0, -1).join('.'); // Obtiene el nombre sin extensión
    // Guarda el nombre del archivo CSV para usarlo luego
      window.csvFileName = csvFileName;
    // Continúa con el proceso normal de carga
      loadCSV(csvFile);
    });
    // Función para cargar un archivo CSV
    function cargarCSV() {
      const fileInput = document.getElementById("csv-file");
      const file = fileInput.files[0];
 
     const csvFileName = file.name.split('.').slice(0, -1).join('.'); // Obtiene el nombre sin extensión
    
    // Guarda el nombre del archivo CSV para usarlo luego
    window.csvFileName = csvFileName;

      if (!file) {
        alert("Por favor, selecciona un archivo CSV.");
        return;
      }

      const reader = new FileReader();
      const modal = document.getElementById("loading-modal");

      // Mostrar la ventana modal
      modal.classList.remove("hidden");

      reader.onload = async function (event) {
        try {
          const csvData = event.target.result;
          const productos = parseCSV(csvData);

          if (productos.length === 0) {
            alert("El archivo CSV está vacío o no contiene datos válidos.");
            modal.classList.add("hidden");
            return;
          }

          // Simular progreso mientras se cargan los productos
          const totalProductos = productos.length;
          let progreso = 0;

          for (let i = 0; i < totalProductos; i++) {
            const producto = productos[i];
            if (!inventario.has(producto.codigo)) {
              inventario.set(producto.codigo, {
                nombre: producto.nombre,  // Asegurar que el campo coincide con parseCSV()
                codigo: producto.codigo,
                cantidad: producto.cantidad,  // Agregar cantidad
                fecha_caducidad: producto.fecha_caducidad,  // Agregar fecha de caducidad
                  formato: "EAN13"
              });
            } else {
              console.warn(`Producto con código ${producto.codigo} ya existe en el inventario.`);
            }

            // Actualizar la barra de progreso
            progreso = ((i + 1) / totalProductos) * 100;
            actualizarProgressBar(progreso, `Cargando productos (${Math.round(progreso)}%)`);
            await sleep(10); // Simular un pequeño retraso para visualizar el progreso
          }

          // Actualizar la lista de productos en la página
          actualizarListaProductos();

          // Ocultar la ventana modal
          modal.classList.add("hidden");
        } catch (error) {
          console.error("Error al cargar el archivo CSV:", error);
          alert("Ocurrió un error al cargar el archivo CSV. Verifica el formato del archivo.");
          modal.classList.add("hidden");
        }
      };

      reader.onerror = function () {
        alert("Error al leer el archivo CSV.");
        modal.classList.add("hidden");
      };

      reader.readAsText(file);
    }

    // Función para parsear el contenido del CSV
    function parseCSV(csvData) {
  const lines = csvData.split("\n").filter(line => line.trim() !== "");
  const productos = [];

  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    const [codigo, Nombre, Categoria, Marca, TipoCantidad, Cantidad, FechaCaducidad, Comentarios] =
      line.split(",").map(item => item.trim()); // Usa `,` como separador

    if (codigo && Nombre) {
      productos.push({ 
        codigo: codigo, 
        nombre: Nombre,
        cantidad: Cantidad || "N/A",  // Si el campo está vacío, poner "N/A"
        fecha_caducidad: FechaCaducidad || "N/A"
      });
    }
  }

  return productos;
}

    // Función para actualizar la lista de productos en la página
    function actualizarListaProductos() {
      const lista = document.getElementById("lista-productos");
      lista.innerHTML = ""; // Limpiar la lista

      // Iterar sobre el Map para mostrar los productos
      inventario.forEach((producto) => {
        const li = document.createElement("li");
        li.textContent = `${producto.nombre} - ${producto.codigo}`;
        lista.appendChild(li);
      });
    }

    // Función para generar el PDF
    async function generarPDF() {
    const currentDate = new Date().toISOString().split('T')[0]; // Formato YYYY-MM-DD
    const pdfName = `${window.csvFileName}_${currentDate}.pdf`;

      if (inventario.size === 0) {
    alert("No hay productos agregados para generar el PDF.");
    return;
  }

  const modal = document.getElementById("loading-modal");
  modal.classList.remove("hidden");

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  let yOffset = 20; // Posición vertical inicial
  const xOffsetLeft = 20;  // Columna izquierda
  const xOffsetRight = 110; // Columna derecha
  let columna = 0; // 0 = Izquierda, 1 = Derecha
  let productosPorPagina = 0; // Contador de productos en la página

  const productosArray = Array.from(inventario.values());

  for (let i = 0; i < productosArray.length; i += 2) { // Iterar en pares
    const producto1 = productosArray[i];
    const producto2 = productosArray[i + 1]; // Puede ser undefined en la última iteración si es impar

    // Imprimir primer producto en la izquierda
    doc.text(`Producto: ${producto1.nombre}`, xOffsetLeft, yOffset);
    doc.text(`Cantidad: ${producto1.cantidad}`, xOffsetLeft, yOffset + 10);
    doc.setTextColor('red');
    doc.text(`Fecha de Caducidad: ${producto1.fecha_caducidad}`, xOffsetLeft, yOffset + 20);
    doc.setTextColor('black');

    // Código de barras para el primer producto
    const canvas1 = document.createElement("canvas");
    JsBarcode(canvas1, producto1.codigo || "0000000000000", {
      format: producto1.formato,
      displayValue: true,
      fontSize: 12,
      height: 30
    });
    doc.addImage(canvas1.toDataURL("image/png"), "PNG", xOffsetLeft, yOffset + 30, 80, 20);

    // Imprimir segundo producto en la derecha (si existe)
    if (producto2) {
      doc.text(`Producto: ${producto2.nombre}`, xOffsetRight, yOffset);
      doc.text(`Cantidad: ${producto2.cantidad}`, xOffsetRight, yOffset + 10);
      doc.setTextColor('red');
      doc.text(`Fecha de Caducidad: ${producto2.fecha_caducidad}`, xOffsetRight, yOffset + 20);
      doc.setTextColor('black');

      // Código de barras para el segundo producto
      const canvas2 = document.createElement("canvas");
      JsBarcode(canvas2, producto2.codigo || "0000000000000", {
        format: producto2.formato,
        displayValue: true,
        fontSize: 12,
        height: 30
      });
      doc.addImage(canvas2.toDataURL("image/png"), "PNG", xOffsetRight, yOffset + 30, 80, 20);
    }

    yOffset += 60; // Avanzar a la siguiente fila
    productosPorPagina += 2;

    // Si se alcanzan 8 productos, crear una nueva página
    if (productosPorPagina >= 8) {
      doc.addPage();
      yOffset = 20; // Reiniciar posición vertical
      productosPorPagina = 0; // Reiniciar contador
    }
  }

  doc.save(pdfName);
  modal.classList.add("hidden");
}

    // Función para verificar que todas las dependencias estén cargadas
    function verificarDependencias() {
      const modal = document.getElementById("loading-modal");

      // Verificar que JsBarcode y jsPDF estén disponibles
      if (typeof JsBarcode !== "undefined" && typeof window.jspdf !== "undefined") {
        // Ocultar la ventana modal
        modal.classList.add("hidden");
      } else {
        // Intentar nuevamente después de 500 ms
        setTimeout(verificarDependencias, 500);
      }
    }

    // Función para simular un retraso
    function sleep(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }

    // Iniciar la verificación de dependencias cuando se cargue la página
    window.onload = () => {
      verificarDependencias();
    };
  </script>
</body>
</html>